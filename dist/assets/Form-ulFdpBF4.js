import{x as E,g as y,h as ee,y as te,r as n,o as b,c as C,a as e,w as a,d as c,i as U,t as D,A as I,F as j,m as ae,f as le,s as oe,e as i,_ as re}from"./index-DmuTLrRo.js";function ne(p,s=300){let t=null;return(...u)=>{t&&clearTimeout(t),t=setTimeout(()=>{p(...u)},s)}}function se(p,s,{debounceMs:t=800}={}){const u=y(!1);localStorage.getItem(p)&&(u.value=!0);const F=ne(()=>{try{const d=s.value?s.value:s;localStorage.setItem(p,JSON.stringify(d)),u.value=!0}catch(d){console.error("Failed to save draft:",d)}},t);E(s,F,{deep:!0});function B(){const d=localStorage.getItem(p);if(!d)return null;try{return JSON.parse(d)}catch(m){return console.error("Failed to parse draft:",m),null}}function M(){localStorage.removeItem(p),u.value=!1}return{draftExists:u,loadDraft:B,clearDraft:M}}const ie={class:"page"},A="draft_ticket_form",ue=".png,.jpg,.jpeg,.pdf",de=ee({__name:"Form",setup(p){const s=y(null),t=le({title:"",category:void 0,priority:void 0,assignee:void 0,description:"",tags:[]}),u=[{label:"Bug",value:"Bug"},{label:"Feature",value:"Feature"},{label:"Task",value:"Task"}],F=[{label:"Low",value:"Low"},{label:"Medium",value:"Medium"},{label:"High",value:"High"}],B=[{label:"Alice",value:"Alice"},{label:"Bob",value:"Bob"},{label:"Cindy",value:"Cindy"},{label:"David",value:"David"}],M=[{label:"frontend",value:"frontend"},{label:"backend",value:"backend"},{label:"urgent",value:"urgent"},{label:"customer",value:"customer"}],d=oe(()=>({title:[{required:!0,message:"请输入标题"}],category:[{required:!0,message:"请选择分类"}],priority:[{required:!0,message:"请选择优先级"}],assignee:[{required:!0,message:"请选择负责人"}],description:[{validator:async()=>t.priority==="High"&&!t.description.trim()?Promise.reject(new Error("优先级为 High 时必须填写描述")):Promise.resolve(),trigger:["change","blur"]}]})),m=y(!1),T=y([]);function N(o,l){return String((l==null?void 0:l.label)||"").toLowerCase().includes(o.toLowerCase())}function H(o){return["image/png","image/jpeg","application/pdf"].includes(o.type)?(o.size/1024/1024<=5||i.error("单文件最大 5MB"),!1):(i.error("仅支持 png/jpg/pdf 文件"),!1)}E(()=>t.category,o=>{o==="Bug"&&!t.priority&&(t.priority="High")});const{draftExists:q,loadDraft:h,clearDraft:L}=se(A,t,{debounceMs:800}),_=y(!1);function J(o){t.title=o.title??"",t.category=o.category,t.priority=o.priority,t.assignee=o.assignee,t.description=o.description??"",t.tags=o.tags??[]}function P(){const o=h();o&&(J(o),i.success("草稿已恢复")),_.value=!1}function R(){L(),_.value=!1,i.info("草稿已丢弃")}function V(){try{localStorage.setItem(A,JSON.stringify(t)),i.success("草稿已保存")}catch{i.error("草稿保存失败")}}async function z(){if(s.value){m.value=!0;try{await s.value.validate(),await new Promise((o,l)=>{setTimeout(()=>{Math.random()>.2?o(!0):l(new Error("mock 提交失败"))},800)}),i.success("提交成功"),L(),s.value.resetFields(),T.value=[]}catch(o){o!=null&&o.errorFields?i.error("请完善表单后再提交"):i.error((o==null?void 0:o.message)||"提交失败")}finally{m.value=!1}}}return te(()=>{q.value&&(_.value=!0)}),(o,l)=>{const v=n("a-button"),O=n("a-space"),Y=n("a-page-header"),G=n("a-input"),f=n("a-form-item"),g=n("a-col"),x=n("a-select"),S=n("a-row"),w=n("a-card"),Q=n("a-textarea"),W=n("a-upload"),X=n("a-form"),k=n("a-descriptions-item"),Z=n("a-tag"),$=n("a-descriptions"),K=n("a-modal");return b(),C("div",ie,[e(Y,{title:"创建工单 / 创建用户","sub-title":"支持草稿、联动校验与附件上传"},{extra:a(()=>[e(O,null,{default:a(()=>[e(v,{disabled:m.value,onClick:V},{default:a(()=>[...l[8]||(l[8]=[c("保存草稿",-1)])]),_:1},8,["disabled"]),e(v,{type:"primary",loading:m.value,onClick:z},{default:a(()=>[...l[9]||(l[9]=[c("提交",-1)])]),_:1},8,["loading"])]),_:1})]),_:1}),e(S,{gutter:16},{default:a(()=>[e(g,{xs:24,lg:16},{default:a(()=>[e(X,{ref_key:"formRef",ref:s,model:t,layout:"vertical",rules:d.value},{default:a(()=>[e(w,{title:"基础信息",bordered:!1,style:{"margin-bottom":"16px"}},{default:a(()=>[e(S,{gutter:16},{default:a(()=>[e(g,{xs:24,md:12},{default:a(()=>[e(f,{label:"标题",name:"title"},{default:a(()=>[e(G,{value:t.title,"onUpdate:value":l[0]||(l[0]=r=>t.title=r),placeholder:"请输入标题"},null,8,["value"])]),_:1})]),_:1}),e(g,{xs:24,md:12},{default:a(()=>[e(f,{label:"分类",name:"category"},{default:a(()=>[e(x,{value:t.category,"onUpdate:value":l[1]||(l[1]=r=>t.category=r),placeholder:"请选择分类",options:u},null,8,["value"])]),_:1})]),_:1}),e(g,{xs:24,md:12},{default:a(()=>[e(f,{label:"优先级",name:"priority"},{default:a(()=>[e(x,{value:t.priority,"onUpdate:value":l[2]||(l[2]=r=>t.priority=r),placeholder:"请选择优先级",options:F},null,8,["value"])]),_:1})]),_:1}),e(g,{xs:24,md:12},{default:a(()=>[e(f,{label:"负责人",name:"assignee"},{default:a(()=>[e(x,{value:t.assignee,"onUpdate:value":l[3]||(l[3]=r=>t.assignee=r),placeholder:"请选择负责人",options:B,"show-search":"","filter-option":N},null,8,["value"])]),_:1})]),_:1})]),_:1})]),_:1}),e(w,{title:"详情",bordered:!1,style:{"margin-bottom":"16px"}},{default:a(()=>[e(f,{label:"描述",name:"description"},{default:a(()=>[e(Q,{value:t.description,"onUpdate:value":l[4]||(l[4]=r=>t.description=r),rows:4,placeholder:"请输入描述"},null,8,["value"])]),_:1}),e(f,{label:"标签",name:"tags"},{default:a(()=>[e(x,{value:t.tags,"onUpdate:value":l[5]||(l[5]=r=>t.tags=r),mode:"multiple",placeholder:"请选择标签",options:M},null,8,["value"])]),_:1})]),_:1}),e(w,{title:"附件",bordered:!1,style:{"margin-bottom":"16px"}},{default:a(()=>[e(f,{label:"上传附件",name:"attachments"},{default:a(()=>[e(W,{"file-list":T.value,"onUpdate:fileList":l[6]||(l[6]=r=>T.value=r),"before-upload":H,accept:ue,"max-count":5},{default:a(()=>[e(v,null,{default:a(()=>[...l[10]||(l[10]=[c("选择文件",-1)])]),_:1})]),_:1},8,["file-list"]),l[11]||(l[11]=U("div",{class:"hint"},"支持 png/jpg/pdf，单文件最大 5MB，最多 5 个",-1))]),_:1})]),_:1})]),_:1},8,["model","rules"])]),_:1}),e(g,{xs:24,lg:8},{default:a(()=>[e(w,{title:"实时预览",bordered:!1},{default:a(()=>[e($,{column:1,size:"small"},{default:a(()=>[e(k,{label:"标题"},{default:a(()=>[c(D(t.title||"-"),1)]),_:1}),e(k,{label:"分类"},{default:a(()=>[c(D(t.category||"-"),1)]),_:1}),e(k,{label:"优先级"},{default:a(()=>[c(D(t.priority||"-"),1)]),_:1}),e(k,{label:"标签"},{default:a(()=>[t.tags.length?(b(),I(O,{key:0,wrap:""},{default:a(()=>[(b(!0),C(j,null,ae(t.tags,r=>(b(),I(Z,{key:r},{default:a(()=>[c(D(r),1)]),_:2},1024))),128))]),_:1})):(b(),C(j,{key:1},[c("-")],64))]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),e(K,{open:_.value,"onUpdate:open":l[7]||(l[7]=r=>_.value=r),title:"检测到草稿","ok-text":"恢复","cancel-text":"丢弃",onOk:P,onCancel:R},{default:a(()=>[...l[12]||(l[12]=[U("div",null,"发现上次未提交的草稿，是否恢复？",-1)])]),_:1},8,["open"])])}}}),pe=re(de,[["__scopeId","data-v-02ba5a4f"]]);export{pe as default};
